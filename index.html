<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp({
            apiKey: "AIzaSyD5y7J9QdeSy12lSv3M5FAWRzasp5jxcSY",
            authDomain: "dashboard-financiero-706c2.firebaseapp.com",
            projectId: "dashboard-financiero-706c2",
            storageBucket: "dashboard-financiero-706c2.firebasestorage.app",
            messagingSenderId: "861398704500",
            appId: "1:861398704500:web:b7e454cc7c1035cef88c21"
        });

        const db = getFirestore(app);
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('login').style.display = 'flex';
        }, 800);
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; }
        .loading, .login { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading { background: white; }
        .login { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; }
        .login-box { background: white; padding: 50px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
        .login-box h1 { font-size: 24px; color: #667eea; margin-bottom: 30px; text-align: center; }
        .login-box input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; margin-bottom: 20px; }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .error { background: #fee; color: #c33; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: none; }
        .app { display: none; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; }
        .header h1 { font-size: 20px; margin-bottom: 10px; }
        .nav { background: white; padding: 0 30px; display: flex; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav button { padding: 16px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 14px; font-weight: 500; color: #6b7280; }
        .nav button.active { color: #667eea; border-bottom-color: #667eea; }
        .content { max-width: 1400px; margin: 30px auto; padding: 0 30px; }
        .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .kpi-label { font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #111827; margin: 8px 0; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .card h2 { font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #10b981; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; background: #f9fafb; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .page { display: none; }
        .page.active { display: block; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .product-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;"></div>
            <div style="font-size: 18px; font-weight: 600; color: #667eea;">Conectando con Firebase...</div>
        </div>
    </div>

    <div id="login" class="login">
        <div class="login-box">
            <h1>Analytics Dashboard</h1>
            <div id="error" class="error">Contrase帽a incorrecta</div>
            <form onsubmit="login(event)">
                <input type="password" id="password" placeholder="Contrase帽a" required>
                <button type="submit">Iniciar Sesi贸n</button>
            </form>
        </div>
    </div>

    <div id="app" class="app">
        <div class="header">
            <h1>SISTEMA DE CONTROL FINANCIERO EMPRESARIAL</h1>
            <button class="btn" onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Cerrar Sesi贸n</button>
        </div>
        <div class="nav">
            <button class="active" onclick="showPage('overview')">Overview</button>
            <button onclick="showPage('transactions')">Transacciones</button>
            <button onclick="showPage('expenses')">Gastos</button>
            <button onclick="showPage('products')">Productos</button>
        </div>

        <div class="content">
            <div id="overview" class="page active">
                <div class="kpis" id="kpis"></div>
                <div class="card">
                    <h2>Resumen por Producto</h2>
                    <table id="summaryTable"></table>
                </div>
            </div>

            <div id="transactions" class="page">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h2>Transacciones</h2>
                    <button class="btn btn-primary" onclick="openModal('transaction')">+ Nueva Transacci贸n</button>
                </div>
                <div class="card">
                    <table id="transactionsTable"></table>
                </div>
            </div>

            <div id="expenses" class="page">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h2>Gastos Operativos</h2>
                    <button class="btn btn-primary" onclick="openModal('expense')">+ Nuevo Gasto</button>
                </div>
                <div class="card">
                    <table id="expensesTable"></table>
                </div>
            </div>

            <div id="products" class="page">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h2>Productos</h2>
                    <button class="btn btn-primary" onclick="openModal('product')">+ Nuevo Producto</button>
                </div>
                <div class="products-grid" id="productsGrid"></div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h3>Nueva Transacci贸n</h3>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="txDate">
            </div>
            <div class="form-group">
                <label>Producto</label>
                <select id="txProduct"></select>
            </div>
            <div class="form-group">
                <label>Unidades</label>
                <input type="number" id="txUnits" min="0">
            </div>
            <div class="form-group">
                <label>Facturaci贸n (CLP)</label>
                <input type="number" id="txRevenue" min="0">
            </div>
            <div class="form-group">
                <label>Notas</label>
                <input type="text" id="txNotes">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('transaction')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <h3>Nuevo Gasto</h3>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="expDate">
            </div>
            <div class="form-group">
                <label>Categor铆a</label>
                <select id="expCategory">
                    <option>Comisiones</option>
                    <option>Arriendo</option>
                    <option>Servicios</option>
                    <option>Salarios</option>
                </select>
            </div>
            <div class="form-group">
                <label>Descripci贸n</label>
                <input type="text" id="expDescription">
            </div>
            <div class="form-group">
                <label>Monto (CLP)</label>
                <input type="number" id="expAmount" min="0">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('expense')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveExpense()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3 id="productModalTitle">Nuevo Producto</h3>
            <input type="hidden" id="prodId">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="prodName">
            </div>
            <div class="form-group">
                <label>SKU</label>
                <input type="text" id="prodSku">
            </div>
            <div class="form-group">
                <label>Categor铆a</label>
                <input type="text" id="prodCategory">
            </div>
            <div class="form-group">
                <label>Costo Unitario (CLP)</label>
                <input type="number" id="prodCost" min="0">
            </div>
            <div class="form-group">
                <label>Precio Venta (CLP)</label>
                <input type="number" id="prodPrice" min="0">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('product')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProduct()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const PASSWORD = 'Thebix2025CL';
        let products = [], transactions = [], expenses = [];

        function login(e) {
            e.preventDefault();
            if (document.getElementById('password').value === PASSWORD) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                setupListeners();
            } else {
                document.getElementById('error').style.display = 'block';
                setTimeout(() => document.getElementById('error').style.display = 'none', 3000);
            }
        }

        function logout() {
            if (confirm('驴Cerrar sesi贸n?')) location.reload();
        }

        function setupListeners() {
            window.onSnapshot(window.collection(window.db, 'products'), snap => {
                products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderProducts();
                updateSummary();
            });
            window.onSnapshot(window.collection(window.db, 'transactions'), snap => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTransactions();
                updateSummary();
            });
            window.onSnapshot(window.collection(window.db, 'expenses'), snap => {
                expenses = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderExpenses();
            });
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');
        }

        function openModal(type) {
            if (type === 'transaction') {
                document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('txProduct').innerHTML = products.map(p => `<option>${p.name}</option>`).join('');
                document.getElementById('transactionModal').classList.add('active');
            } else if (type === 'expense') {
                document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('expenseModal').classList.add('active');
            } else if (type === 'product') {
                document.getElementById('prodId').value = '';
                document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
                document.getElementById('productModal').classList.add('active');
            }
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').classList.remove('active');
        }

        async function saveTransaction() {
            const data = {
                fecha: document.getElementById('txDate').value,
                producto: document.getElementById('txProduct').value,
                unidades: parseFloat(document.getElementById('txUnits').value) || 0,
                facturacion: parseFloat(document.getElementById('txRevenue').value) || 0,
                notas: document.getElementById('txNotes').value
            };
            await window.addDoc(window.collection(window.db, 'transactions'), data);
            closeModal('transaction');
        }

        async function saveExpense() {
            const data = {
                fecha: document.getElementById('expDate').value,
                categoria: document.getElementById('expCategory').value,
                descripcion: document.getElementById('expDescription').value,
                monto: parseFloat(document.getElementById('expAmount').value) || 0
            };
            await window.addDoc(window.collection(window.db, 'expenses'), data);
            closeModal('expense');
        }

        async function saveProduct() {
            const id = document.getElementById('prodId').value;
            const data = {
                name: document.getElementById('prodName').value,
                sku: document.getElementById('prodSku').value,
                categoria: document.getElementById('prodCategory').value,
                costo: parseFloat(document.getElementById('prodCost').value) || 0,
                precio: parseFloat(document.getElementById('prodPrice').value) || 0
            };
            if (id) {
                await window.updateDoc(window.doc(window.db, 'products', id), data);
            } else {
                await window.addDoc(window.collection(window.db, 'products'), data);
            }
            closeModal('product');
        }

        async function deleteItem(type, id) {
            if (confirm('驴Eliminar?')) {
                await window.deleteDoc(window.doc(window.db, type, id));
            }
        }

        function formatCurrency(val) {
            return new Intl.NumberFormat('es-CL', {style: 'currency', currency: 'CLP', minimumFractionDigits: 0}).format(val);
        }

        function updateSummary() {
            const total = transactions.reduce((sum, t) => sum + t.facturacion, 0);
            const units = transactions.reduce((sum, t) => sum + t.unidades, 0);
            document.getElementById('kpis').innerHTML = `
                <div class="kpi"><div class="kpi-label">Facturaci贸n Total</div><div class="kpi-value">${formatCurrency(total)}</div></div>
                <div class="kpi"><div class="kpi-label">Unidades Vendidas</div><div class="kpi-value">${units}</div></div>
                <div class="kpi"><div class="kpi-label">Productos</div><div class="kpi-value">${products.length}</div></div>
                <div class="kpi"><div class="kpi-label">Transacciones</div><div class="kpi-value">${transactions.length}</div></div>
            `;
            
            let html = '<thead><tr><th>Producto</th><th>Unidades</th><th>Facturaci贸n</th></tr></thead><tbody>';
            const byProduct = {};
            transactions.forEach(t => {
                if (!byProduct[t.producto]) byProduct[t.producto] = {units: 0, revenue: 0};
                byProduct[t.producto].units += t.unidades;
                byProduct[t.producto].revenue += t.facturacion;
            });
            Object.entries(byProduct).forEach(([name, data]) => {
                html += `<tr><td><strong>${name}</strong></td><td>${data.units}</td><td><strong>${formatCurrency(data.revenue)}</strong></td></tr>`;
            });
            document.getElementById('summaryTable').innerHTML = html + '</tbody>';
        }

        function renderProducts() {
            let html = '';
            products.forEach(p => {
                const margin = p.precio > 0 ? ((p.precio - p.costo) / p.precio * 100).toFixed(2) : 0;
                html += `<div class="product-card">
                    <h3>${p.name}</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 4px 0 16px 0;">${p.sku}</p>
                    <div style="margin-bottom: 8px;"><strong>Costo:</strong> ${formatCurrency(p.costo)}</div>
                    <div style="margin-bottom: 8px;"><strong>Precio:</strong> ${formatCurrency(p.precio)}</div>
                    <div style="color: #10b981; font-weight: 600;"><strong>Margen:</strong> ${margin}%</div>
                    <button class="btn" onclick="deleteItem('products','${p.id}')" style="background: #ef4444; color: white; width: 100%; margin-top: 16px;">Eliminar</button>
                </div>`;
            });
            document.getElementById('productsGrid').innerHTML = html || '<p>No hay productos</p>';
        }

        function renderTransactions() {
            let html = '<thead><tr><th>Fecha</th><th>Producto</th><th>Unidades</th><th>Facturaci贸n</th><th>Acciones</th></tr></thead><tbody>';
            transactions.forEach(t => {
                html += `<tr>
                    <td>${new Date(t.fecha).toLocaleDateString('es-CL')}</td>
                    <td><strong>${t.producto}</strong></td>
                    <td>${t.unidades}</td>
                    <td><strong>${formatCurrency(t.facturacion)}</strong></td>
                    <td><button class="btn" onclick="deleteItem('transactions','${t.id}')" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 12px;">Eliminar</button></td>
                </tr>`;
            });
            document.getElementById('transactionsTable').innerHTML = html + '</tbody>';
        }

        function renderExpenses() {
            let html = '<thead><tr><th>Fecha</th><th>Categor铆a</th><th>Descripci贸n</th><th>Monto</th><th>Acciones</th></tr></thead><tbody>';
            expenses.forEach(e => {
                html += `<tr>
                    <td>${new Date(e.fecha).toLocaleDateString('es-CL')}</td>
                    <td>${e.categoria}</td>
                    <td>${e.descripcion}</td>
                    <td><strong style="color: #ef4444;">${formatCurrency(e.monto)}</strong></td>
                    <td><button class="btn" onclick="deleteItem('expenses','${e.id}')" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 12px;">Eliminar</button></td>
                </tr>`;
            });
            document.getElementById('expensesTable').innerHTML = html + '</tbody>';
        }
    </script>
</body>
</html>
